!function(g,Y,J){"use strict";var r="ht",f=g[r],X=f.Default,j=X.def,q=X.getInternal();f.HistoryManager=function(t){this._histories=[],this.setDataModel(t)},j(f.HistoryManager,Y,{ms_ac:["dataModel","histories","historyIndex","maxHistoryCount","disabled"],ms_fire:1,_historyIndex:-1,_betweenTransaction:0,_maxHistoryCount:200,_disabled:!1,ignoredPropertyMap:{imageLoaded:!0,children:!0,attaches:!0,shape:!0,childChange:!0,agentChange:!0,sourceAgent:!0,targetAgent:!0,edgeGroup:!0,"*":!0},ignoreDataModelPropertyMap:{},beginInteraction:function(){this.beginTransaction()},endInteraction:function(){this.endTransaction()},beginTransaction:function(){if(!this._disabled){var Q=this;Q._betweenTransaction++,1===Q._betweenTransaction&&(Q._transactionHistories=[])}},endTransaction:function(){if(!this._disabled){var F=this,I=F._histories;F._betweenTransaction>0&&F._betweenTransaction--,0===F._betweenTransaction&&(F._transactionHistories&&F._transactionHistories.length&&(I=I.slice(0,F._historyIndex+1),I.push(F._transactionHistories),I.length>F._maxHistoryCount&&(I=I.slice(I.length-F._maxHistoryCount)),F.setHistories(I),F.setHistoryIndex(I.length-1,!0)),delete F._transactionHistories)}},setDataModel:function(Q){var $=this,Z=$._dataModel;Z!==Q&&(Z&&(delete Z._historyManager,Z.ump($.handleDataModelPropertyChange,$),Z.umm($.$5p,$),Z.umd($.$6p,$),Z.removeHierarchyChangeListener($.handleHierarchyChange,$),Z.removeIndexChangeListener($.handleIndexChange,$)),$._dataModel=Q,Q&&(Q._historyManager=$,Q.mp($.handleDataModelPropertyChange,$),Q.mm($.$5p,$),Q.md($.$6p,$),Q.addHierarchyChangeListener($.handleHierarchyChange,$),Q.addIndexChangeListener($.handleIndexChange,$)),$.fp("dataModel",Z,Q),$.clear())},setHistoryIndex:function(M,I){var j=this,r=j._historyIndex,E=j._histories.length;if(-1>M?M=-1:M>=E&&(M=E-1),r!==M){if(!I){var Y=M-r;Y>0?j.$2p(Y):0>Y&&j.$1p(-Y)}j._historyIndex=M,j.fp("historyIndex",r,M),j.dataModel&&j.dataModel.onHistoryManagerChanged()}},setMaxHistoryCount:function(f){var k=this,U=k._histories,z=k._maxHistoryCount;(!f||0>=f)&&(f=10),z!==f&&(k._maxHistoryCount=f,k.fp("maxHistoryCount",z,f),U.length>f&&k.clear())},cloneValue:function(W){return f.Default.clone(W)},isPropertyUndoable:function(r){return r&&!this.ignoredPropertyMap[r]},isDataModelPropertyUndoable:function(h){return h&&!this.ignoreDataModelPropertyMap[h]},$5p:function(N){this.handleChange(N,N.kind)},$6p:function(c){this.handleChange(c,"property")},handleHierarchyChange:function(x){this.handleChange(x,"hierarchy")},handleIndexChange:function(m){this.handleChange(m,"index")},handleDataModelPropertyChange:function(p){this.handleChange(p,"dataModelProperty")},toChildrenInfo:function(N){var l={};return l.data=N,l.children=[],N.eachChild(function(F){l.children.push(this.toChildrenInfo(F))},this),l},restoreChildren:function(Y){var s=Y.data;Y.children.forEach(function(V){var i=V.data;i.getParent()!==s&&s.addChild(i),this._dataModel.contains(i)||this._dataModel.add(i),this.restoreChildren(V)},this)},handleChange:function(z,Z){var Y=this;if(!(Y._disabled||Y._isUndoRedoing||X.loadingRefGraph)){var w,e=(Y._histories,z.data),L=z.property;if(!e||!(e._refGraph||e instanceof f.RefGraph)){if("property"===Z)Y.isPropertyUndoable(L,e)&&(w={kind:Z,data:e,property:L,oldValue:Y.cloneValue(z.oldValue,e,L),newValue:Y.cloneValue(z.newValue,e,L),event:z});else if("hierarchy"===Z||"index"===Z)w={kind:Z,data:e,oldIndex:z.oldIndex,newIndex:z.newIndex,event:z};else if("clear"===Z)w={kind:Z,json:z.json,event:z};else if("add"===Z){if(w={kind:Z,data:e,event:z,childrenInfo:this.toChildrenInfo(e),parent:e.getParent()},w.parent){var o=Y._dataModel.getSiblings(e);w.siblingsIndex=o.indexOf(e)}e instanceof f.Node&&(w.host=e.getHost(),w.attaches=e.getAttaches()?e.getAttaches().toArray():J),e instanceof f.Edge&&(w.source=e.getSource(),w.target=e.getTarget())}else"remove"===Z?w={kind:Z,data:e,event:z}:"dataModelProperty"===Z&&Y.isDataModelPropertyUndoable(L,e)&&(w={kind:Z,property:L,oldValue:Y.cloneValue(z.oldValue,e,L),newValue:Y.cloneValue(z.newValue,e,L),event:z});Y.addHistory(w)}}},addHistory:function(N){var T=this;if(N)if(T._betweenTransaction){var q=!1;if("property"===N.kind||"dataModelProperty"===N.kind)for(var i=T._transactionHistories.length-1;i>=0;i--){var M=T._transactionHistories[i];if(N.kind===M.kind&&N.property===M.property&&N.data===M.data){N.oldValue=M.oldValue,T._transactionHistories[i]=N,q=!0;break}}q||T._transactionHistories.push(N)}else{var g=T._histories;g=g.slice(0,T._historyIndex+1),g.push([N]),g.length>T._maxHistoryCount&&(g=g.slice(g.length-T._maxHistoryCount)),T.setHistories(g),T.setHistoryIndex(g.length-1,!0)}},canUndo:function(){return!this._disabled&&this._historyIndex>=0&&this._historyIndex<this._histories.length},canRedo:function(){return!this._disabled&&this._historyIndex>=-1&&this._historyIndex<this._histories.length-1},undo:function(h){(!h||0>=h)&&(h=1),this.setHistoryIndex(this._historyIndex-h)},$1p:function(b){if(this.canUndo()){var N,j=this,v=j._dataModel,a=j._histories,w=j._historyIndex,Y=0;for(j._isUndoRedoing=!0,X.setIsolating(!0);b>0;){if(w>=0&&w<a.length){Y++,N=a[w],w--;for(var l=N.length-1;l>=0;l--){var U=N[l],_=U.kind,n=U.data,x=U.property,o=U.event,K=this.cloneValue(U.oldValue,n,x);if(U.undo)U.undo();else if("add"===_)v.remove(n,{keepChildren:!0});else if("remove"===_)v.contains(n)||v.add(n,o.rootsIndex,o.datasIndex);else if("clear"===_)v.deserialize(X.clone(U.json));else if("property"===_)if("parent"===x)K?K.addChild(n,o.oldIndex):(n.setParent(K),o.oldIndex>=0&&v.moveTo(n,o.oldIndex));else{var h=null;0===x.indexOf("a:")?(h="attr",x=x.replace("a:","")):0===x.indexOf("s:")?(h="style",x=x.replace("s:","")):0===x.indexOf("f:")&&(h="field",x=x.replace("f:","")),q.setPropertyValue(n,h,x,K)}else if("dataModelProperty"===_){var h=null;0===x.indexOf("a:")?(h="attr",x=x.replace("a:","")):0===x.indexOf("s:")?(h="style",x=x.replace("s:","")):0===x.indexOf("f:")&&(h="field",x=x.replace("f:","")),q.setPropertyValue(v,h,x,K)}else"hierarchy"===_?v.moveTo(n,U.oldIndex):"index"===_&&v.moveToIndex(n,U.oldIndex)}}b--}X.setIsolating(!1),delete j._isUndoRedoing,j.afterUndo(Y)}},afterUndo:function(){},redo:function(X){(!X||0>=X)&&(X=1),this.setHistoryIndex(this._historyIndex+X)},$2p:function(t){if(this.canRedo()){var n,N=this,Z=N._dataModel,v=N._histories,$=N._historyIndex,e=0;for(N._isUndoRedoing=!0,X.setIsolating(!0);t>0;){if($>=-1&&$<v.length-1){e++,$++,n=v[$];for(var u=0;u<n.length;u++){var W=n[u],Y=W.kind,S=W.data,d=W.property,k=W.event,z=this.cloneValue(W.newValue,S,d);if(W.redo)W.redo();else if("add"===Y)W.parent&&!S.getParent()&&W.parent.addChild(S,W.siblingsIndex),Z.contains(S)||Z.add(S,k.rootsIndex,k.datasIndex),this.restoreChildren(W.childrenInfo),S instanceof f.Node&&(S.setHost(W.host),W.attaches&&W.attaches.forEach(function(M){M.setHost(S)})),S instanceof f.Edge&&(S.setSource(W.source),S.setTarget(W.target));else if("remove"===Y)Z.remove(S);else if("clear"===Y)Z.clear();else if("property"===Y)if("parent"===d)z?z.addChild(S,k.newIndex):(S.setParent(z),k.newIndex>=0&&Z.moveTo(S,k.newIndex));else{var p=null;0===d.indexOf("a:")?(p="attr",d=d.replace("a:","")):0===d.indexOf("s:")?(p="style",d=d.replace("s:","")):0===d.indexOf("f:")&&(p="field",d=d.replace("f:","")),q.setPropertyValue(S,p,d,z)}else if("dataModelProperty"===Y){var p=null;0===d.indexOf("a:")?(p="attr",d=d.replace("a:","")):0===d.indexOf("s:")?(p="style",d=d.replace("s:","")):0===d.indexOf("f:")&&(p="field",d=d.replace("f:","")),q.setPropertyValue(Z,p,d,z)}else"hierarchy"===Y?Z.moveTo(S,W.newIndex):"index"===Y&&Z.moveToIndex(S,W.newIndex)}}t--}X.setIsolating(!1),delete N._isUndoRedoing,this.afterRedo(e)}},afterRedo:function(){},clear:function(){this.setHistories([]),this.setHistoryIndex(-1,!0),this._betweenTransaction=0,delete this._transactionHistories}})}("undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:(0,eval)("this"),Object);